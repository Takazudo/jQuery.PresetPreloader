/*! jQuery.ImgLoader - v0.1.0 -  3/29/2012
 * https://github.com/Takazudo/jQuery.ImgLoader
 * Copyright (c) 2012 "Takazudo" Takeshi Takatsudo; Licensed MIT */((function(){var a=Array.prototype.slice,b=Object.prototype.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};(function(b,d,e){var f,g;return f=b.ImgLoaderNs={},f.createCachedFunction=function(a){var c;return c={},function(d){return c[d]||(c[d]=b.Deferred(function(b){return a(b,d)}).promise()),c[d]}},f.fetchImg=f.createCachedFunction(function(a,c){var d,e,f;return f=new Image,e=function(){return f.onload=f.onerror=null},a.always(e),d=b(f),f.onload=function(){return a.resolve(d)},f.onerror=function(){return a.reject(d)},f.src=c}),function(){var a;return a={},f.loadImg=function(c){return b.Deferred(function(b){return f.fetchImg(c).then(function(d){var e,f;return a[c]||(a[c]=d),e=a[c],f=e.clone(),a[c]=f,b.resolve(e)},function(a){return b.reject(a)})}).promise()}}(),g=function(a){return b.Deferred(function(b){return setTimeout(function(){return b.resolve()},a)})},f.Event=function(){function b(){this._callbacks={}}return b.prototype.bind=function(a,b){var c,d,e,f,g;c=a.split(" ");for(f=0,g=c.length;f<g;f++)d=c[f],(e=this._callbacks)[d]||(e[d]=[]),this._callbacks[d].push(b);return this},b.prototype.one=function(a,b){return this.bind(a,function(){return this.unbind(a,arguments.callee),b.apply(this,arguments)})},b.prototype.trigger=function(){var b,c,d,e,f,g,h;b=1<=arguments.length?a.call(arguments,0):[],d=b.shift(),e=(h=this._callbacks)!=null?h[d]:void 0;if(!e)return;for(f=0,g=e.length;f<g;f++){c=e[f];if(c.apply(this,b)===!1)break}return this},b.prototype.unbind=function(a,b){var c,d,e,f,g;if(!a)return this._callbacks={},this;e=(g=this._callbacks)!=null?g[a]:void 0;if(!e)return this;if(!b)return delete this._callbacks[a],this;for(d=0,f=e.length;d<f;d++){c=e[d];if(c!==b)continue;e=e.slice(),e.splice(d,1),this._callbacks[a]=e;break}return this},b}(),f.LoaderItem=function(a){function d(a){this.src=a,d.__super__.constructor.apply(this,arguments)}return c(d,a),d.prototype.load=function(){var a=this;return b.Deferred(function(b){return f.loadImg(a.src).pipe(function(c){return a.$img=c,a.trigger("success",a.$img),a.trigger("complete",a.$img),b.resolve(a.$img)},function(c){return a.$img=c,a.trigger("error",a.$img),a.trigger("complete",a.$img),b.reject(a.$img)})}).promise()},d}(f.Event),f.BasicLoader=function(d){function e(){e.__super__.constructor.apply(this,arguments),this.items=[]}return c(e,d),e.prototype.add=function(a){var c;return b.type(a)==="string"&&(c=a,a=new f.LoaderItem(c)),this.items.push(a),a},e.prototype.load=function(){var c,d,e=this;return c=0,d=b.map(this.items,function(a){return a.bind("complete",function(a){return e.trigger("itemload",a,c),c++}).load()}),b.Deferred(function(c){return b.when.apply(e,d).always(function(){var d,f;return f=1<=arguments.length?a.call(arguments,0):[],d=b(f),e.trigger("allload",d),c.resolve(d)})})},e.prototype.kill=function(){return b.each(this.items,function(a,b){return b.unbind()}),this.trigger("kill"),this.unbind(),this},e}(f.Event),f.ChainLoader=function(a){function d(a,c){this._pipesize=a,this._delay=c!=null?c:0,d.__super__.constructor.apply(this,arguments),this._presets=[],this._doneCount=0,this._inLoadCount=0,this._allDoneDefer=b.Deferred()}return c(d,a),d.prototype._finished=function(){return this._doneCount===this._presets.length},d.prototype._nextLoadAllowed=function(){return this._inLoadCount<this._pipesize},d.prototype._getImgs=function(){return b(b.map(this._presets,function(a){return a.item.$img}))},d.prototype._handleNext=function(){var a,c=this;return this._finished()?this._allloadFired?this:(this._allloadFired=!0,a=this._getImgs(),this.trigger("allload",a),this._allDoneDefer.resolve(a),this):(b.each(this._presets,function(a,b){return b.started?!0:c._nextLoadAllowed()?(c._inLoadCount++,b.started=!0,b.item.one("complete",function(d){return b.done=!0,setTimeout(function(){var e;return e=function(){return c.trigger("itemload",d,c._doneCount),c._inLoadCount--,c._doneCount++,b.defer.resolve(d),c._handleNext()},a===0?e():c._presets[a-1].defer.always(function(){return e()})},c._delay)}),b.item.load()):!1}),this)},d.prototype.add=function(a){var c,d;return b.type(a)==="string"&&(d=a,a=new f.LoaderItem(d)),c={item:a,done:!1,started:!1,defer:b.Deferred()},this._presets.push(c),c.defer},d.prototype.load=function(){return this._handleNext(),this._allDoneDefer},d.prototype.kill=function(){return b.each(this._presets,function(a,b){return b.item.unbind()}),this.trigger("kill"),this.unbind(),this},d}(f.Event),f.LoaderFacade=function(){function e(a){var c,d=this;if(!(this instanceof arguments.callee))return new f.LoaderFacade(a);this.options=c=b.extend({srcs:[],pipesize:0,delay:100},a),c.pipesize?this.loader=new f.ChainLoader(c.pipesize,c.delay):this.loader=new f.BasicLoader,b.each(c.srcs,function(a,b){return d.loader.add(new f.LoaderItem(b))})}var c,d=this;return c=["bind","trigger","load","one","unbind","add","kill"],b.each(c,function(b,c){return e.prototype[c]=function(){var b;return b=1<=arguments.length?a.call(arguments,0):[],this.loader[c].apply(this.loader,b)}}),e}.call(this),function(){var a,c,d,e,h;return d={},a=null,c=function(){return b.Deferred(function(c){return b(function(){return a=b('<div id="calcNaturalWH-tempholder"></div>').css({position:"absolute",left:"-9999px",top:"-9999px"}),b("body").append(a),c.resolve()})}).promise()},e=function(a){return a.naturalWidth===void 0||a.naturalWidth===0||a.naturalHeight===void 0||a.naturalHeight===0?!1:!0},h=function(c,e){var f;return c=c.clone(),f=c[0],b.Deferred(function(h){var i,j,k,l;return l={},c.css({width:"auto",height:"auto"}),i=b("<div></div>").append(c),a.append(i),j=0,k=function(){return l.width=f.naturalWidth||c.width(),l.height=f.naturalHeight||c.height(),j>10?(i.remove(),h.reject()):!l.width||!l.height?(j++,g(100).done(function(){return k()})):(d[e],i.remove(),h.resolve(l))},k()}).promise()},f.calcNaturalWH=f.createCachedFunction(function(a,b){return f.loadImg(b).then(function(f){var g,i;return g=f[0],e(g)?(i={width:g.naturalWidth,height:g.naturalHeight},d[b]=i,a.resolve(i,f)):c().done(function(){return h(f,b).then(function(b){return a.resolve(b,f)},function(){return a.reject()})})},function(){return a.reject()})})}(),b.loadImg=f.loadImg,b.ImgLoader=f.LoaderFacade,b.calcNaturalWH=f.calcNaturalWH})(jQuery,this,this.document)})).call(this);